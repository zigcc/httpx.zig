name: Release
permissions:
  contents: write

on:
  release:
    types: [published]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: mlugg/setup-zig@v2.1.0
        with:
          version: 0.15.2
      - name: Run Tests
        run: zig build test

  bench:
    name: Run Benchmarks
    needs: test
    runs-on: ubuntu-latest
    outputs:
      bench_output: ${{ steps.run_bench.outputs.bench_output }}
    steps:
      - uses: actions/checkout@v4
      - uses: mlugg/setup-zig@v2.1.0
        with:
          version: 0.15.2
      - name: Run Benchmarks
        id: run_bench
        run: |
          zig build bench || true
          echo "bench_output<<EOF" >> $GITHUB_OUTPUT
          echo "Benchmark results would go here" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  build-library:
    name: Build Library (${{ matrix.target }})
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - x86_64-windows
          - x86-windows
          - x86_64-linux
          - x86-linux
          - aarch64-linux
          - x86_64-macos
          - aarch64-macos
    steps:
      - uses: actions/checkout@v4
      - uses: mlugg/setup-zig@v2.1.0
        with:
          version: 0.15.2
      
      - name: Build Library
        run: zig build -Doptimize=ReleaseSafe -Dtarget=${{ matrix.target }}

      - name: Prepare Release Artifacts
        run: |
          mkdir -p release
          if [[ "${{ matrix.target }}" == *"windows"* ]]; then
            cp zig-out/lib/httpx.lib release/httpx-${{ matrix.target }}.lib || true
          else
            cp zig-out/lib/libhttpx.a release/libhttpx-${{ matrix.target }}.a || true
          fi

      - name: Upload Release Artifacts
        run: |
          gh release upload "${{ github.event.release.tag_name }}" release/* --clobber || true
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  update-release:
    name: Update Release Description
    needs: [test, bench]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Update Release Body
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ${{ github.event.release.body }}

            ## ⬇️ Downloads

            See assets below.
